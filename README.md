# lamp

STM32L432KC driving WS2812B LEDs.

---

<details markdown="1">
  <summary>Table of Contents</summary>

- [1 WS2812B](#1-ws2812b)
    - [1.1 Clocks](#11-clocks)
    - [1.2 PWM Timer](#12-pwm-timer)
        - [1.2.1 Timer Calculations](#121-timer-calculations)
    - [1.3 DMA](#13-dma)
    - [1.4 NVIC](#14-nvic)
    - [1.5 WS2812B Driver](#15-ws2812b-driver)
        - [1.5.1 PWM Duty Cycle Calculations](#151-pwm-duty-cycle-calculations)
        - [1.5.2 Reset Code Time Periods Calculation](#152-reset-code-time-periods-calculation)

</details>

---

## 1 WS2812B

Following setup for the STM32L432KC.

### 1.1 Clocks

APB2: 80 MHz (Clock for TIM1CH[1:4]).

All subsequent calculations assume an 80 MHz peripheral clock on the PWM timer
channel (STM32L432KC).

### 1.2 PWM Timer

A PWM timer is utilized generate pulse timing signals to the WS2812B.

PA8 → Timer 1 Channel 1 → PWM Generation CH1.

```c
htim1.Instance = TIM1;
htim1.Init.Prescaler = 1-1;
htim1.Init.CounterMode = TIM_COUNTERMODE_UP;
htim1.Init.Period = 100-1;
htim1.Init.ClockDivision = TIM_CLOCKDIVISION_DIV1;
htim1.Init.RepetitionCounter = 0;
htim1.Init.AutoReloadPreload = TIM_AUTORELOAD_PRELOAD_DISABLE;
```

#### 1.2.1 Timer Calculations

Given the PWM equation:

$$f_{PWM} = \frac{f_{TIM}}{ \left( ARR + 1 \right) \times \left( PSC + 1
\right) }$$

- $f_{TIM} = 80 \space \mathrm{MHz}$
    - Defined by the PWM channel's peripheral clock.
- $ARR = 100 - 1$
    - Counter period, aka Auto Reload Register (ARR) of 100 is used to simplify
      the translation of duty cycle percentages.
- $f_{PWM} = 800 \space \mathrm{kHz}$
    - As specified by the WS2812B datasheet, the target data transfer time
      period is 1.25 µs.
    - Calculating for required PWM frequency:
        - $f_{PWM} = \frac{1}{1.25 \times 10 ^{-6} \space \mathrm{s}} = 800
          \space \mathrm{kHz}$

Thus, the prescaler, $PSC = 1 - 1$.

### 1.3 DMA

DMA is used to transfer the color data for the WS2812B LEDs directly from memory
to the PWM timer's registers without requiring CPU overhead.

On CubeMX, configure `TIM1_CH1` for a DMA channel:

- Memory to Peripheral.
- Normal request with memory increment addressing, data width "Byte".

### 1.4 NVIC

NVIC is used to efficiently manage the interrupt generated by the DMA controller
upon the completion of a data transfer. This allows the system to update the PWM
signals for the WS2812B LEDs with minimal CPU overhead, enabling efficient and
responsive control of the LEDs.

On CubeMX, enable NVIC for TIM1.

### 1.5 WS2812B Driver

The WS2812B driver is made of 2 files:

1. [driver_ws2812b.h](Core/Inc/driver_ws2812b.h)
2. [driver_ws2812b.c](Core/Src/driver_ws2812b.c)

#### 1.5.1 PWM Duty Cycle Calculations

Duty cycle required for PWM control:

$$D = \frac{PW}{T} \times 100$$

- $D$ = Duty cycle, required calculation.
- $PW$ = Pulse width (active time), as defined by the datasheet.
- $T$ = Total signal time period, 1.25 µs, as defined by the datasheet.

| Operation | $PW$   | Margin  | $D$ |
|-----------|--------|---------|-----|
| 0 code    | 0.4 µs | ±150 ns | 32% |
| 1 code    | 0.8 µs | ±150 ns | 64% |

#### 1.5.2 Reset Code Time Periods Calculation

The datasheet requires a low signal of > 50 µs. Thus, the number of full (low)
cycles is given by:

$$50 \space \mathrm{\mu s} \div 1.25 \space \mathrm{\mu s} = 40$$
